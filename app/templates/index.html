<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teaching Helper</title>
    <link rel="icon" href="/static/logo.png" type="image/png">
    <style>
        :root {
            --primary-color: #0066cc;
            --secondary-color: #f0f7ff;
            --accent-color: #28a745;
            --text-color: #333;
            --light-gray: #f5f5f5;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0;
            color: var(--text-color);
            background-color: #f9f9f9;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23e0e0e0' fill-opacity='0.4' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
        }
        
        .app-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1em 2em;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .app-title {
            display: flex;
            align-items: center;
            margin: 0;
        }
        
        .app-logo {
            height: 40px;
            margin-right: 15px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2em;
        }
        
        label { 
            display: block; 
            margin-bottom: 0.5em; 
            font-weight: 500;
        }
        
        select, textarea { 
            width: 100%; 
            margin-bottom: 1em; 
            padding: 0.7em; 
            box-sizing: border-box; 
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }
        
        button { 
            padding: 0.7em 1.5em; 
            cursor: pointer; 
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #0055aa;
        }
        
        .loading { 
            font-style: italic; 
            color: grey;
        }
        
        /* New styles for recommendation box */
        #result { 
            margin-top: 1em; 
            padding: 0; 
            border: 1px solid #ccc; 
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
            background-color: white;
        }
        
        .result-header {
            background-color: var(--secondary-color);
            padding: 1em;
            border-bottom: 1px solid #ccc;
        }
        
        .result-body {
            padding: 1em;
            background-color: white;
        }
        
        .result-title {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .result-description {
            margin-bottom: 1em;
        }
        
        .result-rationale {
            font-style: italic;
            color: #555;
            margin-bottom: 1em;
            padding-left: 1em;
            border-left: 3px solid #ddd;
        }
        
        /* Add a new style for rationale section with header */
        .rationale-section {
            margin: 1em 0;
            padding: 1em;
            background-color: #f5f9ff;
            border-radius: 6px;
            border: 1px solid #d0e0ff;
        }
        
        .rationale-header {
            margin-top: 0;
            margin-bottom: 0.5em;
            color: var(--primary-color);
            font-size: 1.1em;
            font-weight: bold;
        }
        
        .rationale-content {
            font-style: italic;
            color: #333;
            line-height: 1.4;
        }

        /* Planning process section */
        .planning-process {
            margin: 1em 0;
            padding: 1em;
            background-color: #f7f7f7;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 0.9em;
            color: #555;
        }
        
        .planning-process-title {
            font-weight: bold;
            margin-bottom: 0.5em;
            color: #333;
        }
        
        /* Alternative recommendations section */
        .alt-recommendations {
            margin-top: 1.5em;
            border-top: 1px solid #eee;
            padding-top: 1em;
        }
        
        .alt-recommendations-title {
            font-weight: bold;
            margin-bottom: 1em;
            color: #333;
        }
        
        .alt-recommendation {
            margin-bottom: 1em;
            padding: 0.8em;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        
        .alt-recommendation h4 {
            margin-top: 0;
            margin-bottom: 0.5em;
            color: var(--primary-color);
        }
        
        .alt-recommendation h4 a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .alt-recommendation h4 a:hover {
            text-decoration: underline;
        }
        
        .alt-title-container {
            display: flex;
            align-items: center;
            margin-bottom: 0.5em;
        }
        
        /* Browser selection styles */
        .browser-selection {
            margin-bottom: 1em;
            padding: 1em;
            background-color: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        .browser-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1em;
        }

        .browser-count {
            font-size: 0.9em;
            color: #666;
            display: flex;
            align-items: center;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected {
            background-color: var(--accent-color);
            box-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
        }
        
        .status-disconnected {
            background-color: #dc3545;
            box-shadow: 0 0 5px rgba(220, 53, 69, 0.5);
        }

        .refresh-browsers {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9em;
            padding: 0;
            text-decoration: underline;
        }
        
        .launch-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.7em 1.5em;
            cursor: pointer;
            display: inline-block;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.2s;
            margin: 0 0 1.2em 0;
        }
        
        .launch-btn:hover {
            background-color: #218838;
        }
        
        .launch-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        /* Form styles */
        .form-card {
            background-color: white;
            border-radius: 8px;
            padding: 1.5em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2em;
        }
        
        .form-title {
            margin-top: 0;
            color: var(--primary-color);
            margin-bottom: 1em;
            font-size: 1.5em;
        }
        
        .form-submit-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.8em 1.5em;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: auto;
            margin: 1em 0 0.5em;
        }
        
        .form-submit-btn:hover {
            background-color: #0055aa;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-icon {
            margin-right: 8px;
        }
        
        /* Use This Instead button */
        .use-alt-btn {
            background-color: #0066cc;
            color: white;
            font-size: 0.8em;
            padding: 0.5em 1em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 0.5em;
            display: inline-block;
            font-weight: 500;
            transition: background-color 0.15s ease-in-out;
        }
        
        .use-alt-btn:hover {
            background-color: #0055aa;
            transform: translateY(-1px);
        }
        
        /* Activity header styles */
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1em;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.8em;
        }
        
        .activity-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.4em;
        }
        
        .activity-header .launch-btn {
            margin: 0;
        }
        
        /* Title link and domain styles */
        .title-container {
            flex: 1;
            margin-right: 1em;
        }
        
        .title-container h3 {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .title-container a {
            color: var(--primary-color);
            text-decoration: none;
            margin-right: 0.5em;
            position: relative;
            display: inline-block;
        }
        
        .title-container a:hover {
            text-decoration: underline;
            color: #0055aa;
        }
        
        .domain-label {
            font-size: 0.7em;
            color: #666;
            font-weight: normal;
            background-color: #f0f0f0;
            padding: 0.3em 0.6em;
            border-radius: 3px;
            white-space: nowrap;
            display: inline-block;
            vertical-align: middle;
        }

        /* Add new styles for the browser selection and launch section */
        .browser-launch-container {
            display: flex;
            align-items: center;
            margin-bottom: 1em;
            padding-bottom: 1em;
            border-bottom: 1px solid #eee;
        }
        
        .browser-selection-inline {
            display: flex;
            align-items: center;
            width: 100%;
        }
        
        .browser-selection-inline label {
            margin-bottom: 0;
            margin-right: 10px;
            white-space: nowrap;
        }
        
        .browser-selection-inline select {
            margin-bottom: 0;
            margin-right: 15px;
            flex: 1;
            max-width: 400px;
        }
        
        .browser-selection-inline .launch-btn {
            margin: 0;
        }
        
        #browserList {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }
        
        #browserList div {
            margin-bottom: 5px;
            padding: 5px;
            background-color: #f0f7ff;
            border-radius: 4px;
        }

        /* Add styles for no browsers message */
        .no-browsers-msg {
            padding: 10px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            color: #666;
            font-style: italic;
            text-align: center;
        }

        /* Add styles for browser error message */
        .browser-error-msg {
            padding: 10px;
            background-color: #fff8f8;
            border: 1px solid #ffdddd;
            border-radius: 4px;
            color: #cc0000;
            font-style: italic;
            text-align: center;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <h1 class="app-title">
            <img src="/static/logo.png" alt="Teaching Helper Logo" class="app-logo">
            Teaching Helper
        </h1>
    </header>
    
    <div class="container">
        <div class="form-card">
            <h2 class="form-title">Connected Browsers</h2>
            <div class="browser-selection">
                <div class="browser-info">
                    <span class="browser-count">
                        <span id="statusIndicator" class="status-indicator status-disconnected"></span>
                        <span id="browserCount">0 browsers connected</span>
                    </span>
                    <button type="button" class="refresh-browsers" id="refreshBrowsers">Refresh</button>
                </div>
                <div id="browserList">
                    <!-- Browser list will be populated dynamically -->
                </div>
            </div>
        </div>

        <div class="form-card">
            <h2 class="form-title">Plan Student Activity</h2>
            <form id="activityForm">
                <label for="gradeLevel">Grade Level:</label>
                <select id="gradeLevel" name="gradeLevel" required>
                    <option value="">Select Grade</option>
                    <option value="K">Kindergarten</option>
                    <option value="1">1st Grade</option>
                    <option value="2">2nd Grade</option>
                    <option value="3">3rd Grade</option>
                    <option value="4">4th Grade</option>
                    <option value="5">5th Grade</option>
                    <option value="6">6th Grade</option>
                    {/* Add more grades if needed */}
                </select>

                <label for="workingOn">Working on:</label>
                <textarea id="workingOn" name="workingOn" rows="4" required placeholder="e.g., fractions, sentence structure, historical events..."></textarea>

                <button type="submit" class="form-submit-btn">
                    <span class="btn-icon">🚀</span>
                    Plan Activity
                </button>
            </form>
        </div>

        <div id="result">
            <div class="result-header">
                <h2 class="result-title">Suggested Activity</h2>
            </div>
            <div class="result-body">
                <div id="loading" class="loading">Planning activity...</div>
                <div id="recommendation" style="display: none;">
                    <div class="activity-header">
                        <div class="title-container">
                            <h3>
                                <a id="activity-title" href="#" target="_blank"></a>
                                <span id="activity-domain" class="domain-label"></span>
                            </h3>
                        </div>
                    </div>
                    
                    <div class="browser-launch-container">
                        <div class="browser-selection-inline">
                            <label for="browserSelect"><strong>Selected Browser:</strong></label>
                            <select id="browserSelect" name="browserSelect">
                                <!-- Browser options will be populated dynamically -->
                            </select>
                            <button id="launch-btn" class="launch-btn" disabled>Launch Activity</button>
                        </div>
                    </div>
                    
                    <p id="activity-description" class="result-description"></p>
                    <div class="rationale-section">
                        <h4 class="rationale-header">Rationale</h4>
                        <p id="activity-rationale" class="rationale-content"></p>
                    </div>
                    
                    <!-- Planning process explanation -->
                    <div class="planning-process" id="planning-process-section">
                        <div class="planning-process-title">How This Activity Was Selected</div>
                        <p id="planning-process"></p>
                    </div>
                    
                    <!-- Alternative recommendations section -->
                    <div class="alt-recommendations" id="alt-recommendations-section" style="display: none;">
                        <div class="alt-recommendations-title">Alternative Activities</div>
                        <div id="alt-recommendations-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('activityForm');
        const resultDiv = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');
        const recommendationDiv = document.getElementById('recommendation');
        const activityTitle = document.getElementById('activity-title');
        const activityDomain = document.getElementById('activity-domain');
        const activityDescription = document.getElementById('activity-description');
        const activityRationale = document.getElementById('activity-rationale');
        const launchBtn = document.getElementById('launch-btn');
        const browserSelect = document.getElementById('browserSelect');
        const browserCount = document.getElementById('browserCount');
        const refreshBrowsers = document.getElementById('refreshBrowsers');
        const browserList = document.getElementById('browserList');
        
        let currentActivityLink = '';

        // Function to extract domain from URL
        function extractDomain(url) {
            if (!url) return '';
            try {
                const domain = new URL(url).hostname;
                return domain.replace('www.', '');
            } catch (e) {
                console.error('Error extracting domain:', e);
                return '';
            }
        }

        // Function to fetch and update connected browsers
        async function updateBrowsers() {
            try {
                const response = await fetch('/api/clients');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const browsers = await response.json();
                const statusIndicator = document.getElementById('statusIndicator');
                
                browserSelect.innerHTML = '';
                browserList.innerHTML = '';
                
                // Add each browser as an option to dropdown and to list
                if (browsers.length === 0) {
                    // Add a message when no browsers are connected
                    const noBrowsersMsg = document.createElement('div');
                    noBrowsersMsg.className = 'no-browsers-msg';
                    noBrowsersMsg.textContent = 'No browsers connected. Please connect a browser using the browser extension.';
                    browserList.appendChild(noBrowsersMsg);
                } else {
                    browsers.forEach(browser => {
                        // Add to dropdown
                        const option = document.createElement('option');
                        option.value = browser.id;
                        option.textContent = `${browser.name} (${browser.id})`;
                        browserSelect.appendChild(option);
                        
                        // Add to list display
                        const browserItem = document.createElement('div');
                        browserItem.textContent = `${browser.name} (${browser.id})`;
                        browserList.appendChild(browserItem);
                    });
                }
                
                // Update the browser count and status indicator
                browserCount.textContent = `${browsers.length} browser${browsers.length !== 1 ? 's' : ''} connected`;
                
                // Update visual status indicator
                if (browsers.length > 0) {
                    statusIndicator.classList.remove('status-disconnected');
                    statusIndicator.classList.add('status-connected');
                } else {
                    statusIndicator.classList.remove('status-connected');
                    statusIndicator.classList.add('status-disconnected');
                }
                
                // Disable launch button if no browsers and we have an activity link
                console.log("Current activity link:", currentActivityLink, "Browsers length:", browsers.length);
                if (browsers.length === 0 && currentActivityLink) {
                    launchBtn.disabled = true;
                    launchBtn.title = "No browsers connected";
                    console.log("No browsers connected, button disabled");
                } else if (currentActivityLink && currentActivityLink.trim() !== '') {
                    launchBtn.disabled = false;
                    launchBtn.title = "";
                    console.log("Browsers connected and activity link exists, enabling button");
                }
                
            } catch (error) {
                console.error('Error fetching browsers:', error);
                browserCount.textContent = "Error loading browsers";
                browserList.innerHTML = ''; // Clear the browser list
                
                // Add error message to browser list
                const errorMsg = document.createElement('div');
                errorMsg.className = 'browser-error-msg';
                errorMsg.textContent = 'Unable to load browsers. Please try refreshing.';
                browserList.appendChild(errorMsg);
                
                const statusIndicator = document.getElementById('statusIndicator');
                statusIndicator.classList.remove('status-connected');
                statusIndicator.classList.add('status-disconnected');
            }
        }
        
        // Initial browser update
        updateBrowsers();
        
        // Set up periodic refresh of browsers (every 10 seconds)
        const browserRefreshInterval = setInterval(updateBrowsers, 10000);
        
        // Manual refresh button
        refreshBrowsers.addEventListener('click', updateBrowsers);

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            resultDiv.style.display = 'block';
            loadingDiv.style.display = 'block';
            recommendationDiv.style.display = 'none';
            launchBtn.disabled = true;

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log("API Response structure:", {
                    hasRecommendation: !!result.recommendation,
                    hasAllRecommendations: !!result.all_recommendations,
                    recommendationCount: result.all_recommendations ? result.all_recommendations.length : 0,
                    mainTitle: result.recommendation ? result.recommendation.title : null,
                    mainLink: result.recommendation ? result.recommendation.link : null,
                });
                
                // Display the structured recommendation data
                const recommendation = result.recommendation;
                activityTitle.textContent = recommendation.title;
                
                // Set the title link and domain if link exists
                if (recommendation.link && recommendation.link.trim() !== '') {
                    activityTitle.href = recommendation.link;
                    activityTitle.setAttribute('href', recommendation.link);
                    console.log("Setting main link:", recommendation.link);
                    const domain = extractDomain(recommendation.link);
                    activityDomain.textContent = domain;
                    activityDomain.style.display = domain ? 'inline' : 'none';
                } else {
                    activityTitle.href = '#';
                    activityTitle.setAttribute('href', '#');
                    activityDomain.style.display = 'none';
                }
                
                activityDescription.textContent = recommendation.description;
                
                // Format and display the rationale
                const formattedRationale = formatRationale(recommendation.rationale);
                activityRationale.innerHTML = formattedRationale;
                
                // Display planning process
                const planningProcessSection = document.getElementById('planning-process-section');
                const planningProcess = document.getElementById('planning-process');
                planningProcess.textContent = result.planning_process || "Activity selected based on grade level and learning objectives.";
                
                // Display alternative recommendations if available
                const altRecommendationsSection = document.getElementById('alt-recommendations-section');
                const altRecommendationsList = document.getElementById('alt-recommendations-list');
                altRecommendationsList.innerHTML = ''; // Clear previous recommendations
                
                // Process alternative recommendations
                if (result.all_recommendations && Array.isArray(result.all_recommendations) && result.all_recommendations.length > 1) {
                    console.log(`Processing ${result.all_recommendations.length} recommendations`);
                    
                    // Skip the first one (primary) and display others
                    const alternatives = result.all_recommendations.slice(1);
                    
                    if (alternatives.length > 0) {
                        console.log(`Found ${alternatives.length} alternative recommendations`);
                        
                        // Process each alternative
                        alternatives.forEach((rec, index) => {
                            console.log(`Creating alternative #${index + 1}: "${rec.title}", has link: ${!!rec.link}`);
                            
                            // Create the recommendation container
                            const altDiv = document.createElement('div');
                            altDiv.className = 'alt-recommendation';
                            
                            // Create the title section
                            const titleContainer = document.createElement('div');
                            titleContainer.className = 'alt-title-container';
                            
                            const title = document.createElement('h4');
                            
                            // Process link if it exists
                            if (rec.link && rec.link.trim() !== '') {
                                // Create the link element
                                const titleLink = document.createElement('a');
                                titleLink.href = rec.link;
                                titleLink.setAttribute('href', rec.link);
                                titleLink.target = '_blank';
                                titleLink.textContent = rec.title;
                                title.appendChild(titleLink);
                                
                                // Add domain label
                                const domain = extractDomain(rec.link);
                                if (domain) {
                                    const domainLabel = document.createElement('span');
                                    domainLabel.className = 'domain-label';
                                    domainLabel.textContent = domain;
                                    domainLabel.style.marginLeft = '8px';
                                    title.appendChild(domainLabel);
                                }
                            } else {
                                // No link, just display text
                                title.textContent = rec.title;
                            }
                            
                            // Add title to container
                            titleContainer.appendChild(title);
                            altDiv.appendChild(titleContainer);
                            
                            // Add description
                            const desc = document.createElement('p');
                            desc.textContent = rec.description;
                            altDiv.appendChild(desc);
                            
                            // Add the "Use This Instead" button if there's a link
                            if (rec.link && rec.link.trim() !== '') {
                                const buttonContainer = document.createElement('div');
                                buttonContainer.style.marginTop = '10px';
                                
                                const useButton = document.createElement('button');
                                useButton.className = 'use-alt-btn';
                                useButton.textContent = 'Use This Instead';
                                
                                useButton.addEventListener('click', () => {
                                    console.log(`Using alternative: "${rec.title}" with link: ${rec.link}`);
                                    
                                    // Update the main recommendation with this one
                                    activityTitle.textContent = rec.title;
                                    activityDescription.textContent = rec.description;
                                    activityRationale.innerHTML = formatRationale(rec.rationale);
                                    currentActivityLink = rec.link;
                                    
                                    // Update the link and domain
                                    activityTitle.href = rec.link;
                                    activityTitle.setAttribute('href', rec.link);
                                    
                                    const domain = extractDomain(rec.link);
                                    activityDomain.textContent = domain;
                                    activityDomain.style.display = 'inline';
                                    
                                    // Enable the launch button
                                    updateBrowsers(); // Refresh browser status and update launch button
                                    
                                    // Scroll to the top of the recommendation
                                    resultDiv.scrollIntoView({ behavior: 'smooth' });
                                });
                                
                                buttonContainer.appendChild(useButton);
                                altDiv.appendChild(buttonContainer);
                            }
                            
                            // Add the completed alternative to the list
                            altRecommendationsList.appendChild(altDiv);
                        });
                        
                        // Show the alternatives section
                        altRecommendationsSection.style.display = 'block';
                    } else {
                        // No alternatives to show
                        altRecommendationsSection.style.display = 'none';
                    }
                } else {
                    // No alternatives array or only one recommendation
                    console.log("No alternative recommendations to display");
                    altRecommendationsSection.style.display = 'none';
                }
                
                // Store the activity link and enable/disable launch button
                currentActivityLink = recommendation.link;
                if (currentActivityLink && currentActivityLink.trim() !== '') {
                    // Only enable if there are browsers connected
                    const browsers = await (await fetch('/api/clients')).json();
                    launchBtn.disabled = browsers.length === 0;
                    
                    // Add debugging to help troubleshoot
                    console.log("Activity link:", currentActivityLink);
                    console.log("Browser count:", browsers.length);
                    console.log("Launch button disabled:", launchBtn.disabled);
                    
                    // If the button is disabled, set a helpful tooltip
                    if (browsers.length === 0) {
                        launchBtn.title = "No browsers connected. Please connect a browser.";
                    } else {
                        launchBtn.title = "";
                    }
                } else {
                    launchBtn.disabled = true;
                    launchBtn.title = "No activity link available or empty link";
                    console.log("No activity link available or empty link");
                }
                
                // Show the recommendation and hide loading
                loadingDiv.style.display = 'none';
                recommendationDiv.style.display = 'block';

            } catch (error) {
                console.error('Error submitting form:', error);
                activityTitle.textContent = 'Error';
                activityDescription.textContent = `Error: ${error.message}`;
                activityRationale.textContent = '';
                launchBtn.disabled = true;
                
                loadingDiv.style.display = 'none';
                recommendationDiv.style.display = 'block';
            }
        });
        
        // Add event listener for launch button
        launchBtn.addEventListener('click', async () => {
            if (!currentActivityLink) return;
            
            launchBtn.disabled = true;
            launchBtn.textContent = 'Launching...';
            
            try {
                // Get the selected browser ID (if any)
                const targetClient = browserSelect.value;
                
                // Build the URL with query parameter if a target is selected
                let url = '/api/launch-activity';
                if (targetClient) {
                    url += `?target_client=${targetClient}`;
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: currentActivityLink }),
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                
                // Success - update button
                const result = await response.json();
                launchBtn.textContent = 'Activity Launched!';
                setTimeout(() => {
                    launchBtn.textContent = 'Launch Activity';
                    launchBtn.disabled = false;
                }, 3000);
                
            } catch (error) {
                console.error('Error launching activity:', error);
                launchBtn.textContent = 'Launch Failed';
                setTimeout(() => {
                    launchBtn.textContent = 'Try Again';
                    launchBtn.disabled = false;
                }, 3000);
            }
        });
        
        // Clean up the interval when the page is unloaded
        window.addEventListener('beforeunload', () => {
            clearInterval(browserRefreshInterval);
        });

        // Function to format rationale text with better readability
        function formatRationale(rationale) {
            if (!rationale) return '';
            
            // Replace bullet points with proper HTML list items
            let formatted = rationale.replace(/- ([^\n]+)/g, '<li>$1</li>');
            
            // If bullet points were found, wrap them in a ul
            if (formatted.includes('<li>')) {
                formatted = '<ul>' + formatted + '</ul>';
            }
            
            // Highlight key phrases
            const highlightPhrases = [
                'grade level', 'skills', 'concepts', 
                'specifically addresses', 'chosen', 'appropriate',
                'local resources', 'web search'
            ];
            
            highlightPhrases.forEach(phrase => {
                const regex = new RegExp(`(${phrase})`, 'gi');
                formatted = formatted.replace(regex, '<strong>$1</strong>');
            });
            
            // Add paragraph breaks for better readability
            formatted = formatted.replace(/\n\n/g, '</p><p>');
            
            return formatted;
        }
    </script>
</body>
</html>